---
# Common role - Install Chocolatey and perform base Windows configuration

- name: Ensure temp directory exists
  ansible.windows.win_file:
    path: "{{ temp_download_path }}"
    state: directory

- name: Install Chocolatey package manager
  ansible.windows.win_shell: |
    Set-ExecutionPolicy Bypass -Scope Process -Force
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
  args:
    creates: C:\ProgramData\chocolatey\bin\choco.exe

- name: Ensure Chocolatey is in PATH
  ansible.windows.win_environment:
    state: present
    name: PATH
    value: "{{ ansible_env.PATH }};C:\\ProgramData\\chocolatey\\bin"
    level: machine
  when: "'chocolatey' not in ansible_env.PATH"

- name: Upgrade Chocolatey to latest version
  chocolatey.chocolatey.win_chocolatey:
    name: chocolatey
    state: latest

- name: Configure Chocolatey to skip confirmation prompts
  ansible.windows.win_shell: choco feature enable -n=allowGlobalConfirmation
  changed_when: false

- name: Install common utilities via Chocolatey
  chocolatey.chocolatey.win_chocolatey:
    name: "{{ item }}"
    state: present
  loop: "{{ common_packages }}"

- name: Ensure Windows Defender exclusions for FRC tools
  ansible.windows.win_shell: |
    Add-MpPreference -ExclusionPath "{{ item }}"
  loop:
    - "C:\\Users\\Public\\wpilib"
    - "C:\\Program Files\\National Instruments"
    - "C:\\Program Files (x86)\\CTRE"
  ignore_errors: true

- name: Enable Developer Mode (helpful for FRC development)
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock
    name: AllowDevelopmentWithoutDevLicense
    data: 1
    type: dword

