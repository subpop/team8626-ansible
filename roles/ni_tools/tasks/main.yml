---
# NI Tools role - Install National Instruments FRC Game Tools
# Note: NI Game Tools is a large installer (~2GB) and takes significant time

- name: Ensure temp directory exists
  ansible.windows.win_file:
    path: "{{ ni_tools_temp_path }}"
    state: directory

- name: Check if NI FRC Game Tools is already installed
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\National Instruments\Common\Installer
  register: ni_installed

- name: Download NI FRC Game Tools installer
  ansible.windows.win_get_url:
    url: "{{ ni_tools_download_url }}"
    dest: "{{ ni_tools_temp_path }}\\{{ ni_tools_installer_name }}"
    timeout: 1800  # 30 minutes - it's a large file
  when: not ni_installed.exists or ni_tools_force_reinstall
  register: ni_download

- name: Extract NI FRC Game Tools installer
  community.windows.win_unzip:
    src: "{{ ni_tools_temp_path }}\\{{ ni_tools_installer_name }}"
    dest: "{{ ni_tools_temp_path }}\\ni_frc_extract"
    creates: "{{ ni_tools_temp_path }}\\ni_frc_extract"
  when: ni_download.changed | default(false)

- name: Install NI FRC Game Tools (silent install - this takes 15-30 minutes)
  ansible.windows.win_shell: |
    $installer = Get-ChildItem -Path "{{ ni_tools_temp_path }}\\ni_frc_extract" -Filter "*.exe" -Recurse | Select-Object -First 1
    if ($installer) {
      Start-Process -FilePath $installer.FullName -ArgumentList "/q /AcceptLicenses yes /r:n" -Wait -NoNewWindow
    } else {
      Write-Error "Installer not found"
      exit 1
    }
  when: ni_download.changed | default(false)
  async: 3600  # Allow up to 1 hour
  poll: 60     # Check every minute
  register: ni_install

- name: Display NI installation result
  ansible.builtin.debug:
    msg: "NI FRC Game Tools installation completed"
  when: ni_install.changed | default(false)

- name: Clean up NI installer files
  ansible.windows.win_file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ ni_tools_temp_path }}\\{{ ni_tools_installer_name }}"
    - "{{ ni_tools_temp_path }}\\ni_frc_extract"
  when: ni_tools_cleanup_installers

